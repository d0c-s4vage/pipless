

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pipless &mdash; pipless 0.1.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="pipless 0.1.1 documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> pipless
          

          
          </a>

          
            
            
              <div class="version">
                0.1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../mappings.html">Mappings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pipless.html">Source Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pipless.html#indices-and-tables">Indices and tables</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">pipless</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>pipless</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pipless</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># encoding: utf-8</span>
<span class="c"># Created by James &quot;d0c_s4vage&quot; Johnson</span>
<span class="c"># https://github.com/d0c-s4vage/pipless</span>
<span class="c"># MIT License</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">pipless creates/activates a virtualenv in which the python process</span>
<span class="sd">will operate. pipless hooks the import process and automatically</span>
<span class="sd">installs missing packages into the current environment.  On process</span>
<span class="sd">exit, pipless will generate a new requirements.txt in the same</span>
<span class="sd">directory that the virtual env folder exists in.</span>

<span class="sd">pipless can be used in three ways:</span>

<span class="sd">1. To directly run scripts:</span>

<span class="sd">    pipless test.py --arg1 --arg2 val</span>

<span class="sd">2. Interactively. Running pipless without a script will drop you</span>
<span class="sd">   into an interactive shell:</span>

<span class="sd">        /tmp $ pipless</span>
<span class="sd">        Python 2.7.10 (default, Oct 14 2015, 16:09:02) </span>
<span class="sd">        [GCC 5.2.1 20151010] on linux2</span>
<span class="sd">        Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span>
<span class="sd">        (InteractiveConsole)</span>
<span class="sd">        &gt;&gt;&gt; </span>
<span class="sd">        </span>
<span class="sd">3. Importing and manually initializing pipless:</span>

<span class="sd">        import pipless</span>
<span class="sd">        pipless.init(..opts..)</span>

<span class="sd">See https://github.com/d0c-s4vage/pipless for more details.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">logo</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">               ░░┐            ▄▄▄       ▄▄▄▄▄▄▄▄▄   ▄▄▄▄▄▄▄▄▄   ▄▄▄▄▄▄▄▄▄ </span>
<span class="s">              ░░┌┘           ▐░░░▌     ▐░░░░░░░░░▌ ▐░░░░░░░░░▌ ▐░░░░░░░░░▌</span>
<span class="s">             ░░┌┘            ▐░░░▌     ▐░░░▛▀▀▀▀▀  ▐░░░▛▀▀▀▀▀  ▐░░░▛▀▀▀▀▀ </span>
<span class="s"> +━━+        └─┘ +━━+        ▐░░░▌     ▐░░░▌       ▐░░░▌       ▐░░░▌      </span>
<span class="s"> ┃╳╳━━━━━━━+ +━+ ┃╳╳━━━━━━━+ ▐░░░▌     ▐░░░▙▄▄▄▄▄  ▐░░░▙▄▄▄▄▄  ▐░░░▙▄▄▄▄▄ </span>
<span class="s"> ┃╳╳┃      ┃ ┃╳┃ ┃╳╳┃      ┃ ▐░░░▌     ▐░░░░░░░░░▌ ▐░░░░░░░░░▌ ▐░░░░░░░░░▌</span>
<span class="s"> ┃╳╳┃      ┃ ┃╳┃ ┃╳╳┃      ┃ ▐░░░▌     ▐░░░▛▀▀▀▀▀   ▀▀▀▀▀▜░░░▌  ▀▀▀▀▀▜░░░▌</span>
<span class="s"> ┃╳╳━━━━━━━+ +━+ ┃╳╳━━━━━━━+ ▐░░░▌     ▐░░░▌             ▐░░░▌       ▐░░░▌</span>
<span class="s"> ┃╳╳┃            ┃╳╳┃        ▟░░░▙▄▄▄▄▄▟░░░▙▄▄▄▄▄▄▄▄▄▄▄▄▄▟░░░▙▄▄▄▄▄▄▄▟░░░▌</span>
<span class="s"> ┃╳╳┃            ┃╳╳┃       ▐░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▌</span>
<span class="s"> +━━+            +━━+        ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ </span>
<span class="s">&quot;&quot;&quot;</span>


<span class="c"># these will be used before we wipe out __main__</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">code</span>
<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">pip</span>
<span class="kn">from</span> <span class="nn">pip.commands.search</span> <span class="kn">import</span> <span class="n">SearchCommand</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;0.1.2&quot;</span>


<span class="n">VENV_ACTIVATED</span> <span class="o">=</span> <span class="bp">False</span>


<div class="viewcode-block" id="PipLessMapping"><a class="viewcode-back" href="../pipless.html#pipless.PipLessMapping">[docs]</a><span class="k">class</span> <span class="nc">PipLessMapping</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class that loads a pipless mapping file</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="PipLessMapping.load"><a class="viewcode-back" href="../pipless.html#pipless.PipLessMapping.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a pipless mapping file into this PipLessMapping instance.</span>
<span class="sd">        Loading a new mapping may overwrite existing (default) mapping</span>
<span class="sd">        entries. No errors are raised if ``path`` does not exist.</span>

<span class="sd">        A mapping file consists of zero or more mapping lines, optionally</span>
<span class="sd">        with comment lines (beginning with ``#``).</span>
<span class="sd">        </span>
<span class="sd">        Each mapping begins with the package name (what you import with),</span>
<span class="sd">        followed by the distribution name (what you install with). E.g.:</span>

<span class="sd">        .. code-block:: text</span>

<span class="sd">           # this is a comment</span>
<span class="sd">           flask  Flask</span>
<span class="sd">   </span>
<span class="sd">           yaml   PyYaml # another comment</span>
<span class="sd">           jinja2 Jinja2</span>


<span class="sd">        :param str path: The path of the mapping file to load.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="c"># remove comment lines</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;#.*&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">mapping_lines</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">mapping_lines</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            
            <span class="c"># split on whitespace</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="PipLessMapping.get"><a class="viewcode-back" href="../pipless.html#pipless.PipLessMapping.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">import_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the distribution name from the mapping for</span>
<span class="sd">        the package name, or ``None`` if it is not defined.</span>

<span class="sd">        :param str import_name: The package name to look up the distribution name for</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">import_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PipLess"><a class="viewcode-back" href="../pipless.html#pipless.PipLess">[docs]</a><span class="k">class</span> <span class="nc">PipLess</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class to automatically install missing python packages into</span>
<span class="sd">    a virtual environment.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">venv_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">no_venv</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the package auto-installer and setup the</span>
<span class="sd">        virtual environment (if it doesn&#39;t already exist).</span>
<span class="sd">        </span>
<span class="sd">        If venv_path is None, a virtual environment named</span>
<span class="sd">        &quot;venv&quot; will be created in the current working directory</span>

<span class="sd">        :param str venv_path: The path to the virtual environment. The requirements.txt wil be saved into</span>
<span class="sd">            this path&#39;s parent directory.</span>
<span class="sd">        :param bool quiet: do not print any output</span>
<span class="sd">        :param bool no_venv: do not create or activate a virtual environment</span>
<span class="sd">        :param bool debug: print verbose debug output</span>
<span class="sd">        :param bool requirements: generate a requirements.txt on program exit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span>               <span class="o">=</span> <span class="n">debug</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span>           <span class="o">=</span> <span class="n">venv_path</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span>       <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">venv_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">venv_parent_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">venv_parent_dir</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_venv</span>             <span class="o">=</span> <span class="n">no_venv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span>               <span class="o">=</span> <span class="n">quiet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_requirements</span>     <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">requirements</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">requirements</span><span class="p">:</span>
            <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_exit</span><span class="p">)</span>

        <span class="c"># keep a reference to these modules. We don&#39;t want to pollute</span>
        <span class="c"># the global namespace by using normal imports. Plus this avoids</span>
        <span class="c"># recursive import problems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imp</span>            <span class="o">=</span> <span class="n">imp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_os</span>             <span class="o">=</span> <span class="n">os</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pip</span>            <span class="o">=</span> <span class="n">pip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sys</span>            <span class="o">=</span> <span class="n">sys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_search_command</span> <span class="o">=</span> <span class="n">SearchCommand</span>

        <span class="c"># load the mapping files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span>        <span class="o">=</span> <span class="n">PipLessMapping</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&quot;mappings.txt&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;~&quot;</span><span class="p">,</span> <span class="s">&quot;.config&quot;</span><span class="p">,</span> <span class="s">&quot;pipless&quot;</span><span class="p">,</span> <span class="s">&quot;mappings.txt&quot;</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;created new PipLess&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;    debug           : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;    venv_home       : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;    venv_parent_dir : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_parent_dir</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;    no_venv         : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_venv</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;    quiet           : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">))</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_venv</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_virtual_env</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;not creating virtual environment&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pip</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">sys</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_pip</span><span class="p">()</span>

        <span class="n">req_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_parent_dir</span><span class="p">,</span> <span class="s">&quot;requirements.txt&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;saving requirements.txt to {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_path</span><span class="p">))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">req_path</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span>
            <span class="n">pip</span><span class="o">.</span><span class="n">main</span><span class="p">([</span><span class="s">&quot;freeze&quot;</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span>

    <span class="k">def</span> <span class="nf">_refresh_pip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;refreshing pip&#39;s module list&quot;</span><span class="p">)</span>

        <span class="c"># Pip keeps track of the currently loaded modules in the current script</span>
        <span class="c"># (and the current working set, etc) by creating a list of modules that</span>
        <span class="c"># are accessible from sys.path (basically).</span>
        <span class="c"># </span>
        <span class="c"># this list is generated when pip is first imported. This function</span>
        <span class="c"># forces that list to be regenerated.</span>
        <span class="kn">from</span> <span class="nn">pip._vendor.pkg_resources</span> <span class="kn">import</span> <span class="n">_initialize_master_working_set</span>
        <span class="n">_initialize_master_working_set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;[PIPLESS]:INF {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;[PIPLESS]:DBG: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<div class="viewcode-block" id="PipLess.activate"><a class="viewcode-back" href="../pipless.html#pipless.PipLess.activate">[docs]</a>    <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Activate the virtual environment.</span>
<span class="sd">        </span>
<span class="sd">        This actually restarts the pipless script using `os.execve()` to</span>
<span class="sd">        replace itself with a subprocess that uses the correct python binary</span>
<span class="sd">        from the venv/bin directory with the correct environment variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_venv</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;no_venv was set, not activating&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">new_environ</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">new_environ</span><span class="p">[</span><span class="s">&quot;PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span><span class="p">,</span> <span class="s">&quot;bin&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">new_environ</span><span class="p">[</span><span class="s">&quot;PATH&quot;</span><span class="p">]</span>
        <span class="n">new_environ</span><span class="p">[</span><span class="s">&quot;VIRTUAL_ENV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span><span class="p">)</span>
        <span class="n">new_environ</span><span class="p">[</span><span class="s">&quot;_&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span><span class="p">,</span> <span class="s">&quot;bin&quot;</span><span class="p">,</span> <span class="s">&quot;python&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;replacing current process with new python in new env from venv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;venv found at {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span><span class="p">))</span>
        <span class="n">venv_python_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span><span class="p">,</span> <span class="s">&quot;bin&quot;</span><span class="p">,</span> <span class="s">&quot;python&quot;</span><span class="p">)</span>

        <span class="n">new_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">venv_python_path</span><span class="p">,</span>
            <span class="s">&quot;-m&quot;</span><span class="p">,</span> <span class="s">&quot;pipless&quot;</span><span class="p">,</span>
            <span class="s">&quot;--no-venv&quot;</span><span class="p">,</span>

            <span class="c"># even though we say to not use the venv, this is still</span>
            <span class="c"># used to determine where to save the requirements.txt file</span>
            <span class="s">&quot;--venv&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;--debug&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;--quiet&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_requirements</span><span class="p">:</span>
            <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;--no-requirements&quot;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">execve</span><span class="p">(</span>
            <span class="n">venv_python_path</span><span class="p">,</span>
            <span class="n">new_args</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">,</span>
            <span class="n">new_environ</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_virtual_env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the new virtual environment if it does not yet exist.</span>
<span class="sd">        </span>
<span class="sd">        Also ensure that pipless.py and the pipless script get copied into</span>
<span class="sd">        the new virtual environment (the new virtual environment should use</span>
<span class="sd">        the same version of pipless as the previou environment).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="kn">import</span> <span class="nn">virtualenv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;creating virtual environment at {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span><span class="p">))</span>
        <span class="n">virtualenv</span><span class="o">.</span><span class="n">create_environment</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span><span class="p">,</span>
            <span class="n">site_packages</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
            <span class="n">clear</span>         <span class="o">=</span> <span class="bp">True</span>
        <span class="p">)</span>

        <span class="n">site_packages_dirs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filesnames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dirname</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dirname</span> <span class="o">==</span> <span class="s">&quot;site-packages&quot;</span><span class="p">:</span>
                    <span class="n">site_packages_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">dirname</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;copying &#39;bin/pipless&#39; into virtual env&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_which</span><span class="p">(</span><span class="s">&quot;pipless&quot;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_home</span><span class="p">,</span> <span class="s">&quot;bin&quot;</span><span class="p">,</span> <span class="s">&quot;pipless&quot;</span><span class="p">))</span>

        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&quot;__init__.py&quot;</span><span class="p">,</span>
            <span class="s">&quot;__main__.py&quot;</span><span class="p">,</span>
            <span class="s">&quot;mappings.txt&quot;</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">file_to_copy</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>

            <span class="n">site_packages_dir</span> <span class="o">=</span> <span class="n">site_packages_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">new_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">site_packages_dir</span><span class="p">,</span> <span class="s">&quot;pipless&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">new_file</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">new_file</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;copying {} into virtual env at &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">file_to_copy</span><span class="p">,</span>
                <span class="n">new_file</span>
            <span class="p">))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file_to_copy</span><span class="p">,</span> <span class="n">new_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_which</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simple function to determine the path of an executable.</span>

<span class="sd">        Borrowed from https://github.com/amoffat/sh/blob/master/sh.py#L300.</span>
<span class="sd">        Thanks Andrew Moffat! sh is pretty awesome :^)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">is_exe</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">fpath</span><span class="p">)))</span>

        <span class="n">fpath</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fpath</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_exe</span><span class="p">(</span><span class="n">program</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">program</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;PATH&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;PATH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">):</span>
                <span class="n">exe_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">program</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_exe</span><span class="p">(</span><span class="n">exe_file</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">exe_file</span>

        <span class="k">return</span> <span class="bp">None</span>

<div class="viewcode-block" id="PipLess.find_module"><a class="viewcode-back" href="../pipless.html#pipless.PipLess.find_module">[docs]</a>    <span class="k">def</span> <span class="nf">find_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is called as the finder part of the sys.meta_path hook that</span>
<span class="sd">        was installed.  See PEP 302 (https://www.python.org/dev/peps/pep-0302/)</span>
<span class="sd">        for more details.</span>

<span class="sd">        Instead of acting as both the finder and the loader object as defined</span>
<span class="sd">        in PEP 302, we only act as the finder object. If a package is not yet</span>
<span class="sd">        installed, but can be installed through PyPI, we install the package,</span>
<span class="sd">        and then return None, meaning that we did not find the package and</span>
<span class="sd">        could not return a loader object with which the package should be loaded.</span>

<span class="sd">        Returning None from this method will cause the normal Python import</span>
<span class="sd">        process to resume, which will pick up our newly installed python</span>
<span class="sd">        package.</span>

<span class="sd">        :param str fullname: The fullname of the module being imported</span>
<span class="sd">        :param str path: Not used by pipless - see PEP 302</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">fullname</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;finding module {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullname</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">mod_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;found module {} at {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">mod_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># it&#39;s already accessible, we don&#39;t need to do anything</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pypi_distro_name</span><span class="p">(</span><span class="n">fullname</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">(</span><span class="s">&quot;module {} exists in pypi, installing&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullname</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">logging</span>
                <span class="n">pip_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&quot;pip&quot;</span><span class="p">)</span>
                <span class="n">_level</span> <span class="o">=</span> <span class="n">pip_log</span><span class="o">.</span><span class="n">level</span>
                <span class="n">pip_log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pip</span><span class="o">.</span><span class="n">main</span><span class="p">([</span><span class="s">&quot;install&quot;</span><span class="p">,</span> <span class="n">fullname</span><span class="p">])</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="n">pip_log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">_level</span><span class="p">)</span>

        <span class="c"># we&#39;ve made it accessible to the normal import procedures</span>
        <span class="c"># now, (should be on sys.path), so we&#39;ll return None which</span>
        <span class="c"># will make Python attempt a normal import</span>
        <span class="k">return</span> <span class="bp">None</span></div>

    <span class="k">def</span> <span class="nf">_get_pypi_distro_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lookup a mapping for the import name ``fullname`` in the</span>
<span class="sd">        mapping files. If a mapping of the package name to the distribution name</span>
<span class="sd">        does not exist, check if an exact match exists in PyPI.</span>

<span class="sd">        :param str fullname: the fullname of the package</span>
<span class="sd">        :returns: returns None if the distribution name is unknown, else</span>
<span class="sd">        the distribution (install) name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mapped_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_package_pypi_mapping_defined</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mapped_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mapped_name</span>

        <span class="c"># TODO maybe use xmlrpclib directly instead of going through pip? - see</span>
        <span class="c"># https://wiki.python.org/moin/PyPIXmlRpc for a good example.</span>
        <span class="n">searcher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_command</span><span class="p">()</span>
        <span class="n">options</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">searcher</span><span class="o">.</span><span class="n">parse_args</span><span class="p">([</span><span class="n">fullname</span><span class="p">])</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">searcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="n">found_match</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fullname</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fullname</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_package_pypi_mapping_defined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the global pipless-mappings file as well as the user&#39;s</span>
<span class="sd">        ~/.config/pipless/mappings file (if it exists) to see if a mapping</span>
<span class="sd">        of the package name to the distribution name exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_run_script</span><span class="p">(</span><span class="n">script_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run the script at the provided path</span>

<span class="sd">    :param str script_file: A path to a python script to run</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">builtins</span> <span class="o">=</span> <span class="n">__builtins__</span>

    <span class="kn">import</span> <span class="nn">__main__</span>
    <span class="n">__main__</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">__main__</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">__name__</span>     <span class="o">=</span> <span class="s">&quot;__main__&quot;</span><span class="p">,</span>
        <span class="n">__file__</span>     <span class="o">=</span> <span class="n">script_file</span><span class="p">,</span>
        <span class="n">__builtins__</span> <span class="o">=</span> <span class="n">builtins</span>
    <span class="p">))</span>
    <span class="nb">globals</span> <span class="o">=</span> <span class="n">__main__</span><span class="o">.</span><span class="n">__dict__</span>
    <span class="nb">locals</span> <span class="o">=</span> <span class="nb">globals</span>

    <span class="c"># repr will put the script_file into quotes and escape any</span>
    <span class="c"># unruly characters</span>

    <span class="c"># NOTE that at this point, sys.argv will already have been reset</span>
    <span class="c"># so that it will look like (from script_file&#39;s point of view),</span>
    <span class="c"># that it was the first file run instead of pipless.</span>
    <span class="k">exec</span> <span class="s">&#39;execfile({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">script_file</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span>


<span class="k">def</span> <span class="nf">_run_interactive_shell</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Run an interactive shell as if it were the first thing being</span>
<span class="sd">    run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">builtins</span> <span class="o">=</span> <span class="n">__builtins__</span>
    <span class="n">code_</span> <span class="o">=</span> <span class="n">code</span>

    <span class="kn">import</span> <span class="nn">__main__</span>
    <span class="n">__main__</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">__main__</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">__name__</span>     <span class="o">=</span> <span class="s">&quot;__main__&quot;</span><span class="p">,</span>

        <span class="c"># normal interactive shell leaves this undefined</span>
        <span class="c"># __file__     = None,</span>

        <span class="n">__builtins__</span> <span class="o">=</span> <span class="n">builtins</span>
    <span class="p">))</span>

    <span class="n">code_</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_find_venv</span><span class="p">(</span><span class="n">start_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recursively search upwards in the directory tree until a</span>
<span class="sd">    venv folder is located. If not found, None is returned</span>

<span class="sd">    :param str start_dir: The start directory from which to search upwards for a venv folder</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">venv_path</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">curr_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">start_dir</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">test_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curr_path</span><span class="p">,</span> <span class="s">&quot;venv&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">test_path</span><span class="p">):</span>
            <span class="n">venv_path</span> <span class="o">=</span> <span class="n">test_path</span>
            <span class="k">break</span>
        <span class="n">new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curr_path</span><span class="p">,</span> <span class="s">&quot;..&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">new_path</span> <span class="o">==</span> <span class="n">curr_path</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">curr_path</span> <span class="o">=</span> <span class="n">new_path</span>

    <span class="k">return</span> <span class="n">venv_path</span>


<div class="viewcode-block" id="init"><a class="viewcode-back" href="../pipless.html#pipless.init">[docs]</a><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">gen_requirements</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Init pipless to work in the currently-running python script.</span>

<span class="sd">    Note that it is assumed that the currently-running script is already</span>
<span class="sd">    either in a virtual environment, or is able to install things</span>
<span class="sd">    normally via &quot;pip install&quot;</span>

<span class="sd">    This function is intended to be used when the pipless module</span>
<span class="sd">    is manually imported into a script.</span>

<span class="sd">    E.g.</span>

<span class="sd">        import pipless</span>
<span class="sd">        pipless.init(... opts ...)</span>
<span class="sd">    </span>
<span class="sd">    :param bool gen_requirements: generate a new requirements.txt before exiting </span>
<span class="sd">    :param bool debug: print all debug statements</span>
<span class="sd">    :param bool quiet: print nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">currframe</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
    <span class="n">calling_frame_info</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getouterframes</span><span class="p">(</span><span class="n">currframe</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">calling_frame</span><span class="p">,</span><span class="n">calling_file</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">calling_frame_info</span>

    <span class="n">pipless_import_hook</span> <span class="o">=</span> <span class="n">PipLess</span><span class="p">(</span>
        <span class="n">no_venv</span>      <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">debug</span>        <span class="o">=</span> <span class="n">debug</span><span class="p">,</span>
        <span class="n">requirements</span> <span class="o">=</span> <span class="n">gen_requirements</span><span class="p">,</span>
        <span class="n">quiet</span>        <span class="o">=</span> <span class="n">quiet</span>
    <span class="p">)</span>
    <span class="c"># NOTE: do not activate it!</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">meta_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pipless_import_hook</span><span class="p">)</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../pipless.html#pipless.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">script_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">venv_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">gen_requirements</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">no_venv</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find or create a virtual environment, setup the automatic</span>
<span class="sd">    importer, and run an interactive shell or a script at the provided path.</span>

<span class="sd">    Note that if no ``venv_path`` is specified, all parent directories will be</span>
<span class="sd">    searched for a ``venv`` folder.</span>

<span class="sd">    E.g., if pipless is run in the directory ``/tmp/test/a/b/c``, and ``venv_path`` is</span>
<span class="sd">    not specified, then the following directories will be checked for existence and used</span>
<span class="sd">    as the ``venv_path`` if found:</span>

<span class="sd">    .. code-block:: text</span>

<span class="sd">        /tmp/test/a/b/c/venv</span>
<span class="sd">        /tmp/test/a/b/venv</span>
<span class="sd">        /tmp/test/a/venv</span>
<span class="sd">        /tmp/test/venv</span>
<span class="sd">        /tmp/venv/</span>
<span class="sd">        /venv</span>

<span class="sd">    The ``requirements.txt`` file will always be written into the directory</span>
<span class="sd">    containing the virtual environment folder.</span>

<span class="sd">    :param str script_file: The python script to run. (can be None)</span>
<span class="sd">    :param str venv_path: The path at which to create/activate the virtual environment</span>
<span class="sd">    :param bool gen_requirements: If a requirements.txt should be generated at process exit.</span>
<span class="sd">    :param bool no_venv: If a virtual environment should not be created/activated.</span>
<span class="sd">    :param bool debug: Display verbose debug statements</span>
<span class="sd">    :param bool quiet: Do not display any text while executing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">script_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># Replace pipless&#39;s dir with script&#39;s dir in front of module search path.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">script_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">venv_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># if we&#39;re running a script file through pipless, search from the script&#39;s</span>
            <span class="c"># directory, not the cwd</span>
            <span class="n">venv_path</span> <span class="o">=</span> <span class="n">_find_venv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">venv_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">venv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">script_file</span><span class="p">),</span> <span class="s">&quot;venv&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">venv_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">venv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">&quot;venv&quot;</span><span class="p">)</span>

    <span class="n">pipless_import_hook</span> <span class="o">=</span> <span class="n">PipLess</span><span class="p">(</span>
        <span class="n">venv_path</span>    <span class="o">=</span> <span class="n">venv_path</span><span class="p">,</span>
        <span class="n">no_venv</span>      <span class="o">=</span> <span class="n">no_venv</span><span class="p">,</span>
        <span class="n">debug</span>        <span class="o">=</span> <span class="n">debug</span><span class="p">,</span>
        <span class="n">quiet</span>        <span class="o">=</span> <span class="n">quiet</span><span class="p">,</span>
        <span class="n">requirements</span> <span class="o">=</span> <span class="n">gen_requirements</span>
    <span class="p">)</span>
    <span class="n">pipless_import_hook</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

    <span class="c"># setup the automatic imports using the venv_path</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">meta_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pipless_import_hook</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">script_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># run the script</span>
        <span class="n">_run_script</span><span class="p">(</span><span class="n">script_file</span><span class="p">)</span>

    <span class="c"># drop into an interactive shell (just as you would run running python with</span>
    <span class="c"># no arguments)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_run_interactive_shell</span><span class="p">()</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, James &#34;doc_s4vage&#34; Johnson.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>